var ns={id:"",stock:[],values:null,from:null,page:1,ischild:0,isReload:!1,silent:function(a,e,c){var b=this,d=top.layer.load(2);layui.$.ajax({type:"POST",url:a,data:e,dataType:"json",success:function(g){top.layer.close(d);0!=g.code?top.layer.msg(g.message||g.msg,{time:2E3}):parent.layer.msg("SUCCESS",{icon:1,time:800},function(){return"function"==typeof c&&c.call(b,g)})}})},getReload:function(){var a=this.isReload;this.isReload=!1;return a},postMessage:function(a){a.params.id&&self.parent.frames[a.params.id].contentWindow.postMessage(a)},listener:function(){function a(c){c=c.data;console.log(e.id+"\u63a5\u6536\u6d88\u606f => "+JSON.stringify(c));"object"==typeof c&&"wost"==c.method&&(e.isReload=c.params.id==e.id&&0==c.params.response.code,window.removeEventListener("message",a,!1),console.log("\u76d1\u542c\u7a97\u53e3"+e.id+"\u5b50\u7a97\u53e3 "+c.params.child_id+"__"+c.params.id+" ==> \u63d0\u4ea4\u5b8c\u6210"))}var e=this;window.addEventListener("message",a,!1)},open:function(a,e,c,b){var d=this;return new Promise(function(g){var h=window.parent;d.listener();h.ns.stock.push({id:d.id,title:e});h.layer.open({type:b||2,title:e||!1,shadeClose:e?!1:!0,content:a,area:c||["60%","60%"],end:function(){var f=self.parent.ns.values;self.parent.ns.values=null;f&&g(f)}})})},close:function(a){a=self.parent.layer.getFrameIndex(this.id);self.parent.layer.close(a)},tableSelected:function(a,e){if("undefined"!==typeof layui.table){a=layui.table.checkStatus(a.config.id).data;if(0===a.length)return"";if(e){for(var c=[],b=0;b<a.length;b++)c.push(a[b][e]);a=c}return a}return[]},wost:function(a,e,c){var b=this;$.post(a,e,function(d){self.parent.ns.values={method:"wost",params:{id:b.from?b.from.id:"",child_id:b.id,url:a,data:e,response:d}};b.ischild&&b.postMessage(self.parent.ns.values);0==d.code?"success"==d.message?parent.layer.msg("SUCCESS",{icon:1,time:800},function(){return"function"==typeof c&&c.call(b,d)}):parent.layer.alert(d.message||d.msg,function(g){parent.layer.close(g);parent.layer.msg("SUCCESS",{icon:1,time:800},function(){return"function"==typeof c&&c.call(b,d)})}):parent.layer.alert(d.message||d.msg,{icon:2})},"json")},img:function(a){return-1==a.indexOf("://")?location.origin+a:a},album:function(a,e){parent.layer.open({type:2,title:"\u56fe\u7247\u7ba1\u7406",area:["825px","675px"],fixed:!1,btn:["\u4fdd\u5b58","\u8fd4\u56de"],content:"/album/admin/album.html?limit="+(e||9999),yes:function(c,b){b=b.find("iframe")[0].contentWindow;b.getCheckItem(function(d){return"function"==typeof a&&a.call(b,d)});parent.layer.close(c)}})},albumRender:function(a){function e(){b.find(".inner").empty();laytpl(g).render({list:h,max:d},function(f){b.find(".inner").append(f);c()})}function c(){b.find(".js-add-image").on("click",function(){ns.album(function(f){var k=h;f.forEach(function(l){return k.values.length<d&&k.push(l.filepath)});b.find('input[type="hidden"]').val(k.join(","));d-=k.length;0>d&&(d=0);e()},d)});b.find("[layer-src]").on("click",function(){var f=this.parentNode;!f.id&&(f.id="img_"+(new Date).getTime(),f.setAttribute("id",f.id));top.layer.photos({photos:{title:"Photos Demo",start:0,data:[{pid:0,src:this.src,thumb:this.src}]},anim:5})});b.find(".js-preview").on("click",function(){$(this).parent().prev().find("img").trigger("click")});b.find(".js-delete").on("click",function(){var f=this.getAttribute("data-index"),k=h;k.splice(f,1);b.find('input[type="hidden"]').val(k.join(","));d+=1;e()})}var b=$(a),d=b.data("limit");a=b.find('input[type="hidden"]').val();var g=$("#uploadImage").html(),h=a?a.split(","):[];d-=h.length;e()},register:function(){(this.ischild=self.frameElement&&"IFRAME"==self.frameElement.tagName?1:0)?(this.id=self.frameElement.getAttribute("data-id"),this.id||(this.id=(new Date).getTime(),self.frameElement.setAttribute("id",(new Date).getTime()),self.frameElement.setAttribute("name",(new Date).getTime()))):this.id=(new Date).getTime();console.log("\u6ce8\u518c"+(this.ischild?"\u5b50":"")+"\u7a97\u53e3 "+this.id);this.ischild&&0<self.parent.ns.stock.length&&(this.from=self.parent.ns.stock.pop(),console.log("\u7236\u7a97\u53e3 "+this.from.id))},view:function(){var a=this;$(".image-uploader").each(function(e,c){return a.albumRender(c)})},clipboard:function(a){layui.config({base:"/static/admin/modules/"}).use("clipboard",function(){layui.clipboard.render({elem:a,success:function(){1!=window.clipboard_flag&&(window.clipboard_flag=!0,top.layer.msg("\u5df2\u590d\u5236",{time:600,success:function(){setTimeout(function(){delete window.clipboard_flag},1E3)}}))}})})},init:function(){var a=this;layui.use(["laytpl","layer","util"],function(){window.$=layui.$;window.laytpl=layui.laytpl;a.register();a.view()})}};